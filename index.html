<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="format-detection" content="telephone=no" />
  <link id="sl-theme" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.15.1/cdn/themes/light.css">
  <script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.15.1/cdn/shoelace.js"></script>
  <link rel="stylesheet" href="assets/ui.css">
  <script defer src="assets/ui.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <title>Blue Marlin Stay ‚Ä¢ Pedidos & Servi√ßos</title>
  <style>
    :root {
      --bg: #f7f7f7;
      --bg-soft: #ffffff;
      --card: #ffffff;
      --line: #ececec;
      --text: #1f1f1f;
      --muted: #6f6f6f;
      --brand: #ea1d2c;
      --brand-2: #f95d66;
      --ok: #16a34a;
      --warn: #ca8a04;
      --danger: #dc2626;
    }
    * { box-sizing: border-box; }
    html, body { min-height: 100dvh; }
    body {
      margin: 0;
      color: var(--text);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: var(--bg);
    }
    .container { max-width: 1150px; margin: 0 auto; padding: 12px; }
    .brand {
      border: 1px solid var(--line);
      background: #fff;
      border-radius: 14px;
      padding: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
      box-shadow: 0 1px 0 rgba(0,0,0,.04);
    }
    .brand-left {
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 0;
    }
    .brand-logo {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      border: 1px solid #ffd3d6;
      background: #fff3f4;
      object-fit: cover;
      flex: 0 0 auto;
    }
    .logo {
      font-weight: 800;
      letter-spacing: .2px;
      font-size: 18px;
      line-height: 1.1;
    }
    .logo span { color: var(--brand); }
    .muted { color: var(--muted); }
    .pill {
      background: #fff2f3;
      border: 1px solid #ffd6d9;
      color: #c81e2b;
      border-radius: 999px;
      font-size: 12px;
      padding: 6px 10px;
    }

    .card {
      border: 1px solid var(--line);
      background: var(--card);
      border-radius: 14px;
      padding: 14px;
      box-shadow: 0 1px 2px rgba(0,0,0,.04);
    }

    .hidden { display: none !important; }

    .step {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
      font-size: 12px;
      color: #777;
    }
    .dot {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      border: 1px solid #ddd;
      display: grid;
      place-items: center;
      font-weight: 700;
      background: #fff;
    }
    .dot.active { background: #ffe8ea; border-color: #ffbcc2; color:#b31220; }

    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }

    label { font-size: 13px; color: var(--muted); display:block; margin-bottom: 6px; }
    input, select {
      width: 100%;
      padding: 11px;
      border-radius: 10px;
      border: 1px solid #ddd;
      background: #fff;
      color: var(--text);
    }
    input[readonly] { opacity: .9; }

    button {
      border: 0;
      border-radius: 10px;
      padding: 10px 12px;
      font-weight: 700;
      cursor: pointer;
    }
    .btn-primary { background: var(--brand); color: #fff; }
    .btn-ghost { background: #fff; border: 1px solid var(--line); color: var(--text); }
    .btn-danger { background: #fff5f5; color: #b91c1c; border: 1px solid #fecaca; }

    .layout {
      display: grid;
      grid-template-columns: 1.5fr 1fr;
      gap: 12px;
    }

    .services {
      margin-top: 12px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px,1fr));
      gap: 10px;
    }
    .service {
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px;
      background: #fff;
      box-shadow: 0 1px 2px rgba(0,0,0,.04);
    }
    .service .top { display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .service small { display:block; min-height: 38px; margin: 7px 0 10px; color: var(--muted); }

    .cart-item {
      border-bottom: 1px dashed var(--line);
      padding: 8px 0;
      display: flex;
      justify-content: space-between;
      gap: 10px;
    }

    .totals { margin-top: 10px; border-top:1px solid var(--line); padding-top: 10px; font-size: 14px; }
    .row { display:flex; justify-content:space-between; margin-bottom: 5px; }

    .chips { display:flex; gap:6px; flex-wrap: wrap; margin-top:8px; }
    .chip { background:#0f2944; border:1px solid #2d4d73; color:#d7e9ff; border-radius:999px; padding:6px 10px; font-size:12px; }

    .parking-grid {
      display:grid;
      grid-template-columns: repeat(5, minmax(44px,1fr));
      gap:8px;
      margin-top:8px;
    }
    .parking-seat {
      border:1px solid #d9d9d9;
      border-radius:10px;
      padding:8px 4px;
      font-size:12px;
      font-weight:700;
      text-align:center;
      user-select:none;
    }
    .parking-seat.available { background:#e8f8ee; color:#166534; border-color:#86efac; cursor:pointer; }
    .parking-seat.unavailable { background:#fde8e8; color:#991b1b; border-color:#fca5a5; cursor:not-allowed; opacity:.8; }
    .parking-seat.selected { background:#dbeafe; color:#1e3a8a; border-color:#93c5fd; }

    .cart-toggle { display: none; width:100%; margin-top: 8px; }

    .fab-cart {
      position: fixed;
      right: 14px;
      bottom: 78px;
      z-index: 30;
      border-radius: 999px;
      background: var(--brand);
      color: #fff;
      border: 0;
      padding: 11px 14px;
      font-weight: 700;
      display: none;
      box-shadow: 0 8px 20px rgba(0,0,0,.2);
    }
    .fab-cart.bump { transform: scale(1.06); transition: transform .2s; }

    .bottom-nav {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 25;
      background: #fff;
      border-top: 1px solid #e8e8e8;
      display: none;
      grid-template-columns: repeat(3,1fr);
      gap: 6px;
      padding: 8px 8px calc(8px + env(safe-area-inset-bottom));
    }
    .bottom-nav button {
      background: #fff;
      border: 1px solid #ececec;
      border-radius: 10px;
      padding: 8px;
      font-size: 12px;
      font-weight: 700;
      color: #333;
    }

    #status { margin-top: 8px; font-size: 12px; }
    .ok { color: var(--ok); }
    .warn { color: var(--warn); }

    @media (max-width: 920px) {
      .container { padding: 10px; }
      .brand { padding: 12px; margin-bottom: 10px; }
      .brand-logo { width: 38px; height: 38px; border-radius: 10px; }
      .logo { font-size: 18px; }
      .layout { grid-template-columns: 1fr; gap: 10px; }
      .grid-2, .grid-3 { grid-template-columns: 1fr; }
      .card { padding: 12px; border-radius: 14px; }
      .services { grid-template-columns: 1fr 1fr; gap: 8px; }
      .service { padding: 8px; }
      .service small { min-height: 28px; font-size: 12px; }
      .service button { padding: 8px; font-size: 13px; }
      .step { margin-bottom: 6px; }
      #screen1 { min-height: calc(100dvh - 92px); display: flex; flex-direction: column; justify-content: center; }

      /* Carrinho menos intrusivo no mobile */
      #screen2 aside.card {
        position: static;
        margin-top: 2px;
        max-height: 56dvh;
        overflow: auto;
      }
      #screen2 aside.card h3 { font-size: 18px; margin-bottom: 2px; }
      #cart .cart-item { padding: 6px 0; }
      #checkout, #clear, #back { padding: 9px 10px; font-size: 14px; }
      .totals { font-size: 13px; }
      .cart-toggle { display:block; }
      .cart-panel.collapsed { display:none; }
      .fab-cart, .bottom-nav { display: grid; }
      .fab-cart { display: block; }
      #screen2 { padding-bottom: 74px; }
      #screen2 aside.card { margin-bottom: 56px; }
    }
    @media (max-width: 560px) {
      .services { grid-template-columns: 1fr; }
      h2 { font-size: 20px; }
      .pill { font-size: 11px; }
    }

    body {
      background:
        radial-gradient(1200px 400px at 10% -10%, rgba(234,29,44,.08), transparent 60%),
        radial-gradient(1000px 300px at 90% -5%, rgba(249,93,102,.08), transparent 60%),
        var(--bg);
    }
    .brand, .card, .service, .parking-seat, button, input, select {
      transition: all .2s ease;
    }
    .card:hover { box-shadow: 0 8px 24px rgba(0,0,0,.06); }
    .service:hover { transform: translateY(-2px); box-shadow: 0 10px 18px rgba(0,0,0,.08); border-color: #e6d3d5; }
    button:active { transform: scale(.98); }
    button:disabled { opacity: .6; cursor: not-allowed; }
    input:focus, select:focus {
      outline: none;
      border-color: #f2a1a7;
      box-shadow: 0 0 0 3px rgba(234,29,44,.12);
    }
    #screen2 aside.card {
      position: sticky;
      top: 12px;
      align-self: start;
      max-height: calc(100dvh - 24px);
      overflow: auto;
    }
    .toast {
      position: fixed;
      left: 50%;
      transform: translateX(-50%) translateY(14px);
      bottom: 18px;
      background: #111827;
      color: #fff;
      padding: 10px 14px;
      border-radius: 999px;
      font-size: 13px;
      box-shadow: 0 12px 24px rgba(0,0,0,.25);
      opacity: 0;
      pointer-events: none;
      z-index: 50;
    }
    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
      transition: all .25s ease;
    }
    @media (max-width: 920px) {
      #screen2 aside.card { position: static; max-height: none; }
    }


    #agendaModal{position:fixed;inset:0;background:rgba(5,10,22,.8);z-index:90;display:none;align-items:center;justify-content:center;padding:10px}
    #agendaModal .box{width:min(980px,96vw);height:min(92vh,920px);background:#0d152f;border:1px solid #2b3c6c;border-radius:12px;overflow:hidden}
    #agendaModal iframe{width:100%;height:calc(100% - 44px);border:0;background:#0b1020}
    #agendaModal .hd{height:44px;display:flex;justify-content:space-between;align-items:center;padding:0 10px;color:#fff;background:#121a33;border-bottom:1px solid #2b3c6c}
  </style>
</head>
<body>
  <div class="container">
    <header class="brand">
      <div class="brand-left">
        <img
          class="brand-logo"
          alt="Logo Blue Marlin"
          src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><defs><linearGradient id='g' x1='0' x2='1'><stop offset='0' stop-color='%2327b7ff'/><stop offset='1' stop-color='%2328dfc0'/></linearGradient></defs><rect width='64' height='64' rx='14' fill='%230a2440'/><path d='M10 39c10 0 18-5 24-14 5-8 9-11 20-13-4 5-7 9-8 13 4-1 7-3 10-6-2 6-6 11-12 15-4 3-9 5-15 5 3 3 8 5 14 6-4 2-8 3-12 3-8 0-15-3-21-9z' fill='url(%23g)'/></svg>"
        />
        <div>
          <div class="logo">Blue <span>Marlin</span> Stay ‚Ä¢ B√∫zios</div>
          <div class="muted">Pedido digital de produtos e servi√ßos ‚Ä¢ experi√™ncia otimizada</div>
        </div>
      </div>
      <div class="header-controls"><span class="pill">Sistema ‚Ä¢ v1</span><sl-switch id="themeToggle" size="small">Dark</sl-switch></div>
    </header>

    <section id="screen1" class="card">
      <div class="step">
        <div class="dot active">1</div><strong>Identifica√ß√£o</strong>
        <div class="dot">2</div><span>Pedidos</span>
      </div>
      <h2 style="margin:0 0 6px">Bem-vindo(a) üëã</h2>
      <p class="muted" style="margin:0 0 12px">Informe seus dados para acessar o painel de pedidos.</p>
      <div class="chips" style="margin:0 0 12px"><span class="chip">Checkout em at√© 30s</span><span class="chip">Interface responsiva</span><span class="chip">Seguran√ßa Supabase</span></div>

      <div class="grid-3">
        <div>
          <label>Telefone WhatsApp</label>
          <sl-input id="guestPhone" type="text" placeholder="Ex.: 5551999990000"></sl-input>
          <p id="phoneHint" class="muted" style="font-size:11px;margin:6px 0 0">Dica: o link personalizado preenche este campo automaticamente.</p>
        </div>
        <div>
          <label>Nome do h√≥spede</label>
          <sl-input id="guestName" type="text" placeholder="Ex.: Jo√£o Silva"></sl-input>
        </div>
        <div>
          <label>N√∫mero do quarto</label>
          <sl-input id="roomNumber" type="text" inputmode="numeric" maxlength="4" placeholder="Ex.: 12"></sl-input>
          <p class="muted" style="font-size:11px;margin:6px 0 0">Use apenas n√∫meros (ex.: 12).</p>
        </div>
      </div>

      <sl-button id="continueBtn" variant="primary" style="margin-top:12px;">Continuar para pedidos</sl-button>
      <p id="statusStep1" class="muted" style="margin-top:8px;font-size:12px"></p>
    </section>

    <section id="screen2" class="hidden">
      <div class="layout">
        <div class="card">
          <div class="step">
            <div class="dot">1</div><span>Identifica√ß√£o</span>
            <div class="dot active">2</div><strong>Pedidos</strong>
          </div>
          <h2 style="margin:0">Painel de pedidos</h2>
          <p id="guestHeader" class="muted" style="margin:4px 0 10px"></p>

          <h3 id="sec-services" style="margin:0 0 8px">Servi√ßos avulsos</h3>
          <div id="services" class="services"></div>

          <div id="sec-parking" class="card" style="margin-top:12px; padding:12px;">
            <h3 style="margin:0">Estacionamento</h3>
            <p class="muted" style="margin:4px 0 10px">Produto separado da di√°ria ‚Ä¢ cobran√ßa por di√°ria</p>
            <div class="grid-2">
              <div>
                <label>Check-in estacionamento</label>
                <sl-input id="parkStartDate" type="date"></sl-input>
              </div>
              <div>
                <label>Check-out estacionamento</label>
                <sl-input id="parkEndDate" type="date"></sl-input>
              </div>
              <div style="grid-column:1 / -1;">
                <label>Per√≠odo r√°pido</label>
                <div class="chips">
                  <button type="button" class="chip" data-nights="1">+1 di√°ria</button>
                  <button type="button" class="chip" data-nights="2">+2 di√°rias</button>
                  <button type="button" class="chip" data-nights="3">+3 di√°rias</button>
                  <button type="button" class="chip" data-nights="7">+7 di√°rias</button>
                </div>
                <p id="parkingNights" class="muted" style="margin:8px 0 0;font-size:12px"></p>
              </div>
              <div>
                <label>Tipo de vaga</label>
                <sl-select id="spotSize" placeholder="Selecionar tipo de vaga">
                  <sl-option value="padrao">Padr√£o</sl-option>
                  <sl-option value="grande">Grande</sl-option>
                </sl-select>
              </div>
              <div style="grid-column:1 / -1;">
                <label>Escolha sua vaga</label>
                <div id="parkingGrid" class="parking-grid"></div>
                <p class="muted" style="font-size:12px;margin:6px 0 0;">üü¢ Dispon√≠vel ¬∑ üî¥ Indispon√≠vel ¬∑ üîµ Selecionada</p>
              </div>
            </div>
            <p id="parkingAvailability" class="muted" style="margin:8px 0 0;font-size:12px"></p>
            <sl-button id="addParking" variant="primary" style="margin-top:10px;">Adicionar estacionamento</sl-button>
          </div>
        </div>

        <aside id="sec-cart" class="card">
          <h3 style="margin:0">Sacola</h3>
          <p class="muted" style="margin:4px 0 10px">Quarto <strong id="roomBadge">-</strong></p>

          <sl-button id="cartToggle" variant="default" class="cart-toggle">Ver/ocultar sacola</sl-button>

          <div id="cartPanel" class="cart-panel">
            <div id="cart"></div>

            <div class="totals">
              <div class="row"><span>Subtotal</span><strong id="subtotal">R$ 0,00</strong></div>
              <div class="row"><span id="feeLabel">Taxa servi√ßo (calculada no fechamento)</span><strong id="fee">R$ 0,00</strong></div>
              <div class="row"><span>Total</span><strong id="total">R$ 0,00</strong></div>
            </div>

            <sl-button id="checkout" variant="primary" style="margin-top:10px;width:100%">Finalizar pedido</sl-button>
            <sl-button id="clear" variant="default" style="margin-top:8px;width:100%">Limpar carrinho</sl-button>
            <sl-button id="back" variant="default" style="margin-top:8px;width:100%">Voltar</sl-button>

            <p id="status" class="muted"></p>
          </div>
        </aside>
      </div>

      <button id="fabCart" class="fab-cart hidden">Sacola (0) ‚Ä¢ R$ 0,00</button>
      <nav id="mobileNav" class="bottom-nav hidden">
        <button type="button" data-target="sec-services">Servi√ßos</button>
        <button type="button" data-target="sec-parking">Estacionamento</button>
        <button type="button" data-target="sec-cart">Sacola</button>
      </nav>
    </section>

    <section id="screen3" class="card hidden">
      <div class="step">
        <div class="dot">1</div><span>Identifica√ß√£o</span>
        <div class="dot">2</div><span>Pedidos</span>
        <div class="dot active">3</div><strong>Sucesso</strong>
      </div>
      <h2 style="margin:0 0 6px">Pedido realizado com sucesso üéâ</h2>
      <p id="successText" class="muted" style="margin:0 0 12px"></p>
      <div class="grid-2">
        <sl-button id="newOrder" variant="primary">Fazer novo pedido</sl-button>
        <sl-button id="backToOrders" variant="default">Voltar para pedidos</sl-button>
      </div>
    </section>
  </div>

  <div id="agendaModal">
    <div class="box">
      <div class="hd">
        <strong>Agenda Operacional Blue Marlin</strong>
        <sl-button id="closeAgendaModal" variant="default" style="width:auto;padding:6px 10px">Fechar</sl-button>
      </div>
      <iframe src="agenda.html"></iframe>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    let services = [
      { id: 'limpeza', name: 'Limpeza avulsa', price: 80, desc: 'Solicita√ß√£o com m√≠nimo de 48h de anteced√™ncia.' },
      { id: 'kit', name: 'Kit boas-vindas', price: 55, desc: 'Amenidades, √°gua e itens essenciais.' },
      { id: 'enxoval', name: 'Reposi√ß√£o de enxoval', price: 45, desc: 'Troca extra de toalhas e roupa de cama.' },
      { id: 'late', name: 'Late checkout', price: 90, desc: 'Extens√£o de hor√°rio, sujeito a disponibilidade.' },
      { id: 'early', name: 'Early check-in', price: 90, desc: 'Acesso antecipado, sujeito a disponibilidade.' },
      { id: 'manut', name: 'Manuten√ß√£o priorit√°ria', price: 120, desc: 'Atendimento emergencial fora do hor√°rio comercial.' }
    ];


    const serviceDescriptionsByCode = {
      limpeza_avulsa: 'Solicita√ß√£o com m√≠nimo de 48h de anteced√™ncia.',
      kit_boas_vindas: 'Amenidades, √°gua e itens essenciais.',
      reposicao_enxoval: 'Troca extra de toalhas e roupa de cama.',
      late_checkout: 'Extens√£o de hor√°rio, sujeito a disponibilidade.',
      early_checkin: 'Acesso antecipado, sujeito a disponibilidade.',
      manutencao_prioritaria: 'Atendimento emergencial fora do hor√°rio comercial.'
    };

    function mapCatalogToUiItems(rows) {
      return (rows || []).map((r, idx) => ({
        id: r.code || `svc-${idx}`,
        code: r.code || `svc-${idx}`,
        name: r.name || 'Servi√ßo',
        price: Number(r.unit_price || 0),
        desc: serviceDescriptionsByCode[r.code] || 'Servi√ßo dispon√≠vel para seu quarto.'
      }));
    }
    const parkingLots = {
      padrao: Array.from({ length: 20 }, (_, i) => `PD${String(i + 1).padStart(2, '0')}`),
      grande: Array.from({ length: 10 }, (_, i) => `GR${String(i + 1).padStart(2, '0')}`)
    };
    const parkingDailyPrice = { padrao: 35, grande: 55 };

    const state = { guest: null, cart: [], parkingBookings: [], serviceFeeApplied: false, accessToken: '', selectedParkingSpot: '', parkingServerReserved: { padrao: new Set(), grande: new Set() }, parkingLastFetchKey: '' };

    function showToast(message, variant='primary') {
      if (window.uiToast) return window.uiToast(message, variant);
      const t = document.getElementById('toast');
      if (!t) return;
      t.textContent = message;
      t.classList.add('show');
      clearTimeout(showToast._tm);
      showToast._tm = setTimeout(() => t.classList.remove('show'), 1800);
    }

    function setCheckoutLoading(isLoading) {
      const btn = document.getElementById('checkout');
      if (!btn) return;
      btn.disabled = !!isLoading;
      btn.textContent = isLoading ? 'Processando pedido...' : 'Finalizar pedido';
    }

    const DEFAULT_SUPABASE_URL = 'https://adifcdvlglntjutalbwk.supabase.co';
    const DEFAULT_SUPABASE_KEY = 'sb_publishable_5A_qAkNtIqRTLOE21y0crw_k5gBJjqS';

    function getSupabaseClient() {
      const params = new URLSearchParams(window.location.search);
      const fromQueryUrl = params.get('sb_url');
      const fromQueryKey = params.get('sb_key');
      const fromStorageUrl = localStorage.getItem('blue_marlin_sb_url');
      const fromStorageKey = localStorage.getItem('blue_marlin_sb_key');

      const sbUrl = fromQueryUrl || fromStorageUrl || DEFAULT_SUPABASE_URL;
      const sbKey = fromQueryKey || fromStorageKey || DEFAULT_SUPABASE_KEY;

      if (fromQueryUrl) localStorage.setItem('blue_marlin_sb_url', fromQueryUrl);
      if (fromQueryKey) localStorage.setItem('blue_marlin_sb_key', fromQueryKey);

      return window.supabase.createClient(sbUrl, sbKey);
    }


    async function trackFunnel(event, meta = {}) {
      try {
        const supabase = getSupabaseClient();
        await supabase.rpc('track_funnel_event_public', {
          p_event: String(event || 'unknown'),
          p_meta: {
            ...meta,
            screen: document.getElementById('screen2')?.classList.contains('hidden') ? 'identify' : 'orders',
            ts: new Date().toISOString()
          }
        });
      } catch (_) {
        // telemetry nunca deve quebrar UX
      }
    }


    async function fetchParkingAvailability(startDate, endDate, size) {
      const supabase = getSupabaseClient();
      const { data, error } = await supabase.rpc('get_parking_availability_public', {
        p_start: startDate,
        p_end: endDate,
        p_size: size || null
      });
      if (error) throw error;
      return data || { reserved: [], available: [] };
    }

    async function loadServicesCatalog() {
      const supabase = getSupabaseClient();
      const { data, error } = await supabase
        .from('services_catalog')
        .select('code,name,unit_price,active')
        .eq('active', true)
        .order('name', { ascending: true });
      if (error) throw error;
      if (Array.isArray(data) && data.length) {
        services = mapCatalogToUiItems(data);
      }
      return services;
    }

    async function saveOrderOnBackend(payload) {
      const supabase = getSupabaseClient();

      const attempt = async (body) => {
        const { data, error } = await supabase.rpc('create_order_public', { p_payload: body });
        if (error) throw new Error(error.message || 'Falha ao salvar pedido');
        if (data?.error) throw new Error(data.message || 'Falha ao salvar pedido');
        return data || {};
      };

      try {
        return await attempt(payload);
      } catch (e) {
        const msg = String(e?.message || '');
        if (/Token de acesso inv√°lido|expirado/i.test(msg)) {
          await ensureAccessToken(payload?.guest?.guestPhone || '', true);
          const retryPayload = { ...payload, accessToken: state.accessToken };
          return await attempt(retryPayload);
        }
        throw e;
      }
    }

    const currency = v => v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    const dateOnly = d => new Date(`${d}T00:00:00`);
    const daysBetween = (start, end) => Math.round((dateOnly(end) - dateOnly(start)) / 86400000);
    const overlaps = (s1,e1,s2,e2) => dateOnly(s1) < dateOnly(e2) && dateOnly(s2) < dateOnly(e1);

    function decodeCtx(ctx) {
      try {
        const b64 = ctx.replace(/-/g, '+').replace(/_/g, '/');
        const json = decodeURIComponent(escape(atob(b64)));
        return JSON.parse(json);
      } catch { return null; }
    }

    function phoneFromParams(params) {
      const keys = ['phone', 'whatsapp', 'wa', 'tel'];
      for (const k of keys) {
        const v = (params.get(k) || '').replace(/\D/g, '');
        if (v) return v;
      }
      const ctx = params.get('ctx');
      if (ctx) {
        const data = decodeCtx(ctx);
        const v = String(data?.phone || '').replace(/\D/g, '');
        if (v) return v;
      }
      return '';
    }

    function applyBrandLogoFromLink() {
      const params = new URLSearchParams(window.location.search);
      const logo = params.get('logo');
      if (!logo) return;
      try {
        const url = new URL(logo);
        if (url.protocol === 'http:' || url.protocol === 'https:') {
          document.querySelector('.brand-logo').src = url.toString();
        }
      } catch {}
    }

    function prefillPhoneFromLink() {
      const input = document.getElementById('guestPhone');
      const hint = document.getElementById('phoneHint');

      const q = new URLSearchParams(window.location.search);
      const tokenFromQuery = q.get('tk') || q.get('token') || '';
      if (tokenFromQuery) {
        state.accessToken = tokenFromQuery;
      }

      let phone = phoneFromParams(q);

      if (!phone && window.location.hash) {
        const h = window.location.hash.startsWith('#') ? window.location.hash.slice(1) : window.location.hash;
        phone = phoneFromParams(new URLSearchParams(h));
      }

      if (!phone) {
        const ref = document.referrer || '';
        try {
          const refUrl = new URL(ref);
          phone = phoneFromParams(refUrl.searchParams);
        } catch {}
      }

      if (!phone) {
        phone = (localStorage.getItem('blue_marlin_phone') || '').replace(/\D/g, '');
      }

      if (phone) {
        input.value = phone;
        input.readOnly = false;
        localStorage.setItem('blue_marlin_phone', phone);
        hint.textContent = 'WhatsApp identificado automaticamente pelo link (voc√™ pode editar).';
      } else {
        input.readOnly = false;
        hint.textContent = 'N√£o veio telefone no link. Para autofill no WhatsApp, envie link personalizado com ?phone=55...';
      }
    }

    function normalizePhone(raw) {
      const digits = String(raw || '').replace(/\D/g, '');
      if (!digits) return '';
      return digits.startsWith('55') ? digits : ('55' + digits);
    }

    function validateStep1() {
      const guestPhone = document.getElementById('guestPhone').value.trim();
      const guestName = document.getElementById('guestName').value.trim();
      const roomNumber = document.getElementById('roomNumber').value.trim();
      if (!guestPhone) return 'Informe o WhatsApp.';
      if (!guestName) return 'Informe o nome.';
      if (!roomNumber) return 'Informe o n√∫mero do quarto.';
      if (!/^\d{1,4}$/.test(roomNumber)) return 'Quarto inv√°lido. Use apenas n√∫meros (ex.: 12).';
      return null;
    }

    async function ensureAccessToken(guestPhone, forceRefresh = false) {
      if (state.accessToken && !forceRefresh) return state.accessToken;
      const supabase = getSupabaseClient();
      const { data, error } = await supabase.rpc('issue_order_access_token_public', { p_phone_raw: guestPhone });
      if (error) throw new Error(error.message || 'Falha ao gerar token de acesso');
      if (data?.error) throw new Error(data.message || 'Falha ao gerar token de acesso');
      state.accessToken = data?.accessToken || '';
      if (!state.accessToken) throw new Error('Token n√£o retornado pelo servidor');
      return state.accessToken;
    }

    function renderServices() {
      const root = document.getElementById('services');
      root.innerHTML = '';
      services.forEach(s => {
        const div = document.createElement('div');
        div.className = 'service';
        div.innerHTML = `
          <div class="top"><strong>${s.name}</strong><strong>${currency(s.price)}</strong></div>
          <small>${s.desc}</small>
          <button class="btn-primary" data-id="${s.id}">Adicionar</button>
        `;
        div.querySelector('button').onclick = () => {
          addItem({
            type: 'servico',
            id: `${s.id}-${Date.now()}`,
            title: s.name,
            detail: `${s.desc} ‚Ä¢ ${state.guest.guestName} (Quarto ${state.guest.roomNumber})`,
            qty: 1,
            unitPrice: s.price
          });
          trackFunnel('add_service', { service_id: s.id, service_name: s.name });
        };
        root.appendChild(div);
      });
    }

    function getAvailableSpots(size, startDate, endDate) {
      const occupiedLocal = new Set(
        state.parkingBookings
          .filter(b => b.size === size && overlaps(startDate, endDate, b.startDate, b.endDate))
          .map(b => b.spot)
      );
      const occupiedServer = state.parkingServerReserved[size] || new Set();
      return parkingLots[size].filter(sp => !occupiedLocal.has(sp) && !occupiedServer.has(sp));
    }

    async function refreshParkingUI() {

      const startEl = document.getElementById('parkStartDate');
      const endEl = document.getElementById('parkEndDate');
      const start = startEl.value;
      const end = endEl.value;
      const size = document.getElementById('spotSize').value;
      const gridEl = document.getElementById('parkingGrid');
      const status = document.getElementById('parkingAvailability');
      const nightsEl = document.getElementById('parkingNights');

      if (start) {
        endEl.min = start;
        if (end && daysBetween(start, end) <= 0) {
          const corrected = new Date(dateOnly(start).getTime() + 86400000).toISOString().slice(0, 10);
          endEl.value = corrected;
        }
      }

      const currentEnd = endEl.value;
      if (!start || !currentEnd || daysBetween(start, currentEnd) <= 0) {
        gridEl.innerHTML = '';
        state.selectedParkingSpot = '';
        status.textContent = 'Defina check-in/check-out v√°lidos.';
        nightsEl.textContent = '';
        return;
      }

      const nights = daysBetween(start, currentEnd);
      nightsEl.textContent = `Per√≠odo selecionado: ${nights} di√°ria${nights > 1 ? 's' : ''}`;

      if (!size) {
        gridEl.innerHTML = '';
        state.selectedParkingSpot = '';
        status.textContent = 'Selecione o tipo de vaga para visualizar as op√ß√µes.';
        return;
      }

      const fetchKey = `${start}|${currentEnd}|${size}`;
      if (state.parkingLastFetchKey !== fetchKey) {
        try {
          const availability = await fetchParkingAvailability(start, currentEnd, size);
          const reserved = Array.isArray(availability?.reserved) ? availability.reserved : [];
          state.parkingServerReserved[size] = new Set(reserved);
          state.parkingLastFetchKey = fetchKey;
        } catch (e) {
          console.warn('Falha ao consultar disponibilidade real:', e?.message || e);
        }
      }

      const available = new Set(getAvailableSpots(size, start, currentEnd));
      const allByType = parkingLots[size] || [];

      if (state.selectedParkingSpot && !available.has(state.selectedParkingSpot)) {
        state.selectedParkingSpot = '';
      }

      gridEl.innerHTML = allByType.map(spot => {
        const isAvailable = available.has(spot);
        const isSelected = state.selectedParkingSpot === spot;
        const klass = isSelected ? 'parking-seat selected' : (isAvailable ? 'parking-seat available' : 'parking-seat unavailable');
        return `<button type="button" class="${klass}" data-spot="${spot}" ${isAvailable ? '' : 'disabled'}>${spot}</button>`;
      }).join('');

      gridEl.querySelectorAll('[data-spot]').forEach(btn => {
        btn.addEventListener('click', () => {
          state.selectedParkingSpot = btn.dataset.spot;
          refreshParkingUI();
        });
      });

      const padrao = getAvailableSpots('padrao', start, currentEnd).length;
      const grande = getAvailableSpots('grande', start, currentEnd).length;
      const sel = state.selectedParkingSpot ? ` ‚Ä¢ Selecionada: ${state.selectedParkingSpot}` : '';
      status.textContent = `Dispon√≠veis no per√≠odo ‚Üí Padr√£o: ${padrao}/20 ‚Ä¢ Grande: ${grande}/10${sel}`;
    }

    function addParking() {
      const start = document.getElementById('parkStartDate').value;
      const end = document.getElementById('parkEndDate').value;
      const size = document.getElementById('spotSize').value;
      const spot = state.selectedParkingSpot;

      if (!start || !end) return setStatus('Preencha as datas do estacionamento.', 'warn');
      if (!size) return setStatus('Selecione o tipo de vaga.', 'warn');
      const nights = daysBetween(start, end);
      if (nights <= 0) return setStatus('Check-out deve ser maior que check-in.', 'warn');
      if (!spot) return setStatus('Selecione uma vaga dispon√≠vel.', 'warn');

      const bookingId = `park-${Date.now()}`;
      state.parkingBookings.push({ bookingId, startDate: start, endDate: end, size, spot });

      addItem({
        type: 'estacionamento',
        id: bookingId,
        bookingId,
        title: `Estacionamento ${spot} (${size})`,
        detail: `${start} ‚Üí ${end} (${nights} di√°ria${nights > 1 ? 's' : ''}) ‚Ä¢ Quarto ${state.guest.roomNumber}`,
        qty: 1,
        unitPrice: nights * parkingDailyPrice[size],
        spot,
        startDate: start,
        endDate: end,
        size,
        nights
      });

      state.selectedParkingSpot = '';
      refreshParkingUI();
      setStatus('Estacionamento adicionado.', 'ok');
      trackFunnel('add_parking', { spot, size, nights });
    }

    function addItem(item) {
      state.cart.push(item);
      state.serviceFeeApplied = false;
      renderCart();
      const fab = document.getElementById('fabCart');
      fab.classList.add('bump');
      setTimeout(() => fab.classList.remove('bump'), 220);
    }

    function removeItem(index) {
      const item = state.cart[index];
      if (item?.type === 'estacionamento') {
        state.parkingBookings = state.parkingBookings.filter(b => b.bookingId !== item.bookingId);
      }
      state.cart.splice(index, 1);
      state.serviceFeeApplied = false;
      renderCart();
      refreshParkingUI();
    }

    function renderCart() {
      const root = document.getElementById('cart');
      root.innerHTML = '';
      if (!state.cart.length) {
        root.innerHTML = '<p class="muted">Sem itens no carrinho.</p>';
      } else {
        state.cart.forEach((item, i) => {
          const div = document.createElement('div');
          div.className = 'cart-item';
          div.innerHTML = `
            <div>
              <strong>${item.title}</strong>
              <div class="muted" style="font-size:12px">${item.detail}</div>
            </div>
            <div style="text-align:right">
              <strong>${currency(item.unitPrice)}</strong>
              <button class="btn-danger" style="margin-top:5px;padding:5px 8px;font-size:12px" data-i="${i}">Remover</button>
            </div>
          `;
          div.querySelector('button').onclick = () => removeItem(i);
          root.appendChild(div);
        });
      }

      const subtotal = state.cart.reduce((a, i) => a + i.unitPrice * i.qty, 0);
      const fee = state.serviceFeeApplied ? subtotal * 0.10 : 0;
      const total = subtotal + fee;
      document.getElementById('subtotal').textContent = currency(subtotal);
      document.getElementById('fee').textContent = state.serviceFeeApplied ? currency(fee) : '‚Äî';
      document.getElementById('total').textContent = currency(total);
      document.getElementById('feeLabel').textContent = state.serviceFeeApplied
        ? 'Taxa servi√ßo (10%)'
        : 'Taxa servi√ßo (calculada no fechamento)';

      const fab = document.getElementById('fabCart');
      fab.textContent = `Sacola (${state.cart.length}) ‚Ä¢ ${currency(total)}`;
    }

    function setStatus(msg, type = '') {
      const el = document.getElementById('status');
      el.textContent = msg;
      el.className = type ? type : 'muted';
      if (msg) showToast(msg);
    }

    document.getElementById('continueBtn').onclick = async () => {
      const err = validateStep1();
      const s = document.getElementById('statusStep1');
      if (err) {
        s.textContent = err;
        s.className = 'warn';
        return;
      }

      state.guest = {
        guestPhone: normalizePhone(document.getElementById('guestPhone').value.trim()),
        guestName: document.getElementById('guestName').value.trim(),
        roomNumber: document.getElementById('roomNumber').value.trim().replace(/\D/g, '')
      };
      localStorage.setItem('blue_marlin_phone', state.guest.guestPhone);

      try {
        await ensureAccessToken(state.guest.guestPhone, true);
      } catch (e) {
        s.textContent = `Falha ao preparar acesso: ${e.message}`;
        s.className = 'warn';
        return;
      }

      document.getElementById('guestHeader').textContent = `${state.guest.guestName} ‚Ä¢ Quarto ${state.guest.roomNumber} ‚Ä¢ WhatsApp ${state.guest.guestPhone}`;
      try { await loadServicesCatalog(); } catch (e) { console.warn('Cat√°logo fallback local:', e?.message || e); }
      document.getElementById('roomBadge').textContent = state.guest.roomNumber;
      document.getElementById('screen1').classList.add('hidden');
      document.getElementById('screen2').classList.remove('hidden');
      document.getElementById('fabCart').classList.remove('hidden');
      document.getElementById('mobileNav').classList.remove('hidden');
      renderServices();
      trackFunnel('identify_continue', { room: state.guest.roomNumber });
    };

    document.getElementById('addParking').onclick = addParking;
    document.getElementById('clear').onclick = () => {
      state.cart = [];
      state.parkingBookings = [];
      state.serviceFeeApplied = false;
      renderCart();
      refreshParkingUI();
      setStatus('Carrinho limpo.');
    };
    document.getElementById('back').onclick = () => {
      document.getElementById('screen2').classList.add('hidden');
      document.getElementById('screen1').classList.remove('hidden');
      document.getElementById('fabCart').classList.add('hidden');
      document.getElementById('mobileNav').classList.add('hidden');
    };

    document.getElementById('backToOrders').onclick = () => {
      document.getElementById('screen3').classList.add('hidden');
      document.getElementById('screen2').classList.remove('hidden');
      document.getElementById('fabCart').classList.remove('hidden');
      document.getElementById('mobileNav').classList.remove('hidden');
    };

    document.getElementById('newOrder').onclick = () => {
      state.cart = [];
      state.parkingBookings = [];
      state.serviceFeeApplied = false;
      renderCart();
      refreshParkingUI();
      document.getElementById('screen3').classList.add('hidden');
      document.getElementById('screen2').classList.remove('hidden');
      document.getElementById('fabCart').classList.remove('hidden');
      document.getElementById('mobileNav').classList.remove('hidden');
      setStatus('Novo pedido iniciado.');
    };

    document.getElementById('checkout').onclick = async () => {
      if (!state.cart.length) return setStatus('Adicione itens antes de finalizar.', 'warn');
      if (!state.accessToken) {
        try {
          await ensureAccessToken(state.guest?.guestPhone || document.getElementById('guestPhone').value);
        } catch (e) {
          return setStatus(`Falha ao gerar token de seguran√ßa: ${e.message}`, 'warn');
        }
      }
      setCheckoutLoading(true);
      state.serviceFeeApplied = true;
      const subtotal = state.cart.reduce((a, i) => a + i.unitPrice * i.qty, 0);
      const fee = subtotal * 0.10;
      const payload = {
        createdAt: new Date().toISOString(),
        accessToken: state.accessToken,
        guest: state.guest,
        items: state.cart,
        totals: { subtotal, fee, total: subtotal + fee }
      };
      renderCart();

      try {
        const saved = await saveOrderOnBackend(payload);
        console.log('MVP_CHECKOUT', { payload, saved });

        const msg = saved?.orderId
          ? `Pedido #${saved.orderId.slice(0,8)} salvo com sucesso para o quarto ${state.guest.roomNumber}.`
          : `Pedido realizado para o quarto ${state.guest.roomNumber} (modo demonstra√ß√£o).`;

        document.getElementById('successText').textContent = msg;
        trackFunnel('checkout_success', { items: state.cart.length, subtotal, fee, total: subtotal + fee });
        setCheckoutLoading(false);
        document.getElementById('screen2').classList.add('hidden');
        document.getElementById('screen3').classList.remove('hidden');
        document.getElementById('fabCart').classList.add('hidden');
        document.getElementById('mobileNav').classList.add('hidden');
      } catch (err) {
        setCheckoutLoading(false);
        trackFunnel('checkout_fail', { reason: String(err?.message || 'unknown') });
        setStatus(`Falha ao salvar pedido: ${err.message}`, 'warn');
      }
    };

    ['parkStartDate', 'parkEndDate', 'spotSize'].forEach(id => {
      document.getElementById(id).addEventListener('change', () => { state.parkingLastFetchKey = ''; refreshParkingUI(); });
    });

    document.querySelectorAll('.chip[data-nights]').forEach(btn => {
      btn.addEventListener('click', () => {
        const nights = Number(btn.dataset.nights || '1');
        const start = document.getElementById('parkStartDate').value;
        if (!start) return;
        const end = new Date(dateOnly(start).getTime() + nights * 86400000).toISOString().slice(0, 10);
        document.getElementById('parkEndDate').value = end;
        refreshParkingUI();
      });
    });

    document.getElementById('cartToggle').onclick = () => {
      const panel = document.getElementById('cartPanel');
      panel.classList.toggle('collapsed');
    };

    document.getElementById('fabCart').onclick = () => {
      document.getElementById('sec-cart').scrollIntoView({ behavior: 'smooth', block: 'start' });
      document.getElementById('cartPanel').classList.remove('collapsed');
    };

    document.querySelectorAll('#mobileNav [data-target]').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.dataset.target;
        const el = document.getElementById(id);
        if (!el) return;
        el.scrollIntoView({ behavior: 'smooth', block: 'start' });
        if (id === 'sec-cart') document.getElementById('cartPanel').classList.remove('collapsed');
      });
    });

    (function init() {
      const now = new Date();
      const today = now.toISOString().slice(0, 10);
      const tomorrow = new Date(now.getTime() + 86400000);
      const afterTomorrow = new Date(now.getTime() + 2 * 86400000);

      const startEl = document.getElementById('parkStartDate');
      const endEl = document.getElementById('parkEndDate');
      startEl.min = today;
      endEl.min = today;

      startEl.value = tomorrow.toISOString().slice(0, 10);
      endEl.value = afterTomorrow.toISOString().slice(0, 10);

      trackFunnel('page_view', { ua: navigator.userAgent, path: location.pathname });
      applyBrandLogoFromLink();
      prefillPhoneFromLink();
      refreshParkingUI();
      renderCart();

      if (window.matchMedia('(max-width: 920px)').matches) {
        document.getElementById('cartPanel').classList.add('collapsed');
      }
    })();
  </script>
</body>
</html>
